-- Huntress Blink Invulnerability v1.0.3
-- Klehrik

log.info("Successfully loaded ".._ENV["!guid"]..".")
require("./helper")

local player = nil

local stored_cooldown = 0     -- Very hacky workaround but I still don't know how to hook into skills directly
local stored_stock = 0



-- ========== Main ==========

gm.pre_script_hook(gm.constants.__input_system_tick, function()
    if player and gm._mod_instance_valid(player) == 1.0 then
        -- Check if character is Huntress
        if player.class == 1.0 then
            local c_skill = player.skills[3].active_skill
            local c_name = c_skill.name
            
            -- Check if utility is Blink
            if c_name == "skill.huntressC.name" then

                -- I already forgot how I arrived at this point but it works :thumbsup:
                if c_skill.stock < c_skill.max_stock then stored_cooldown = math.min(stored_cooldown + 1, c_skill.cooldown) end
                if stored_stock < c_skill.stock then stored_cooldown = 0 end
                stored_stock = c_skill.stock

                -- Check if c_skill button is being pressed
                if player.c_skill == true and not (player.activity == 92.0 and player.activity_type == 7.0) then

                    if stored_cooldown >= c_skill.cooldown or stored_stock > 0 then
                        if stored_stock <= 0 then stored_cooldown = 0 end

                        -- Give 15 frames of immunity
                        -- (Don't override existing immunity if it has more frames)
                        player.invincible = math.max(player.invincible, 15)
                    end
                end
            end
        end

    else
        -- Using pref_name to identify which player is this client
        local pref_name = ""
        local init = find_cinstance_type(gm.constants.oInit)
        if init then pref_name = init.pref_name end

        -- Get the player that belongs to this client
        local players = find_all_cinstance_type(gm.constants.oP)
        if players then
            for i = 1, #players do
                if players[i] then
                    if players[i].user_name == pref_name then
                        player = players[i]
                        break
                    end
                end
            end
        end

    end
end)