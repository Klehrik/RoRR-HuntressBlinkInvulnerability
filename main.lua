-- Huntress Blink Invulnerability v1.0.0
-- Klehrik

log.info("Successfully loaded ".._ENV["!guid"]..".")
require("./helper")

stored_cooldown = 0     -- Very hacky workaround but I still don't know how to hook into skills directly



-- ========== Main ==========

print_once = true

gm.pre_script_hook(gm.constants.__input_system_tick, function()
    -- Decrease stored_cooldown per frame
    stored_cooldown = stored_cooldown - 1


    -- Using pref_name to identify which player is this client
    local pref_name = ""
    local init = find_cinstance_type(gm.constants.oInit)
    if init then pref_name = init.pref_name end


    -- Get the player that belongs to this client
    local player = nil
    local players = find_all_cinstance_type(gm.constants.oP)
    if players then
        for i = 1, #players do
            if players[i] then
                if players[i].user_name == pref_name then
                    player = players[i]
                    break
                end
            end
        end
    end

    if player then
        -- Check if character is Huntress
        if player.class == 1.0 then
            
            -- Check if c_skill button is being pressed
            if player.c_skill == true then

                if stored_cooldown <= 0 then
                    local skills = gm.variable_instance_get(player.id, "skills")
                    local c_skill = gm.variable_struct_get(skills[3], "active_skill")
                    local c_name = gm.variable_struct_get(c_skill, "name")

                    if c_name == "skill.huntressC.name" then
                        local c_cooldown = gm.variable_struct_get(c_skill, "cooldown")
                        stored_cooldown = c_cooldown

                        -- Give 15 frames of immunity
                        -- (Don't override existing immunity if it has more frames)
                        player.invincible = math.max(player.invincible, 15)
                    end
                end
            end

        end
    end
end)