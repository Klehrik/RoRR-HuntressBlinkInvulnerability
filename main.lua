-- Huntress Blink Invulnerability v1.0.2
-- Klehrik

log.info("Successfully loaded ".._ENV["!guid"]..".")
require("./helper")

stored_cooldown = 0     -- Very hacky workaround but I still don't know how to hook into skills directly
stored_stock = 0



-- ========== Main ==========

gm.pre_script_hook(gm.constants.__input_system_tick, function()
    -- Using pref_name to identify which player is this client
    local pref_name = ""
    local init = find_cinstance_type(gm.constants.oInit)
    if init then pref_name = init.pref_name end


    -- Get the player that belongs to this client
    local player = nil
    local players = find_all_cinstance_type(gm.constants.oP)
    if players then
        for i = 1, #players do
            if players[i] then
                if players[i].user_name == pref_name then
                    player = players[i]
                    break
                end
            end
        end
    end

    if player then
        -- Check if character is Huntress
        if player.class == 1.0 then
            local skills = gm.variable_instance_get(player.id, "skills")
            local c_skill = gm.variable_struct_get(skills[3], "active_skill")
            local c_name = gm.variable_struct_get(c_skill, "name")
            
            -- Check if utility is Blink
            if c_name == "skill.huntressC.name" then
                local c_stock = gm.variable_struct_get(c_skill, "stock")
                local c_stock_max = gm.variable_struct_get(c_skill, "max_stock")
                local c_cooldown = gm.variable_struct_get(c_skill, "cooldown")

                -- I already forgot how I arrived at this point but it works :thumbsup:
                if c_stock < c_stock_max then stored_cooldown = math.min(stored_cooldown + 1, c_cooldown) end
                if stored_stock < c_stock then stored_cooldown = 0 end
                stored_stock = c_stock

                -- Check if c_skill button is being pressed
                if player.c_skill == true and not (player.activity == 92.0 and player.activity_type == 7.0) then

                    if stored_cooldown >= c_cooldown or stored_stock > 0 then
                        if stored_stock <= 0 then stored_cooldown = 0 end

                        -- Give 15 frames of immunity
                        -- (Don't override existing immunity if it has more frames)
                        player.invincible = math.max(player.invincible, 15)
                    end
                end
            end
        end
    end
end)